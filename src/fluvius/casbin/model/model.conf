##################################################
# Request Definition
# Defines the fields passed in each enforcement request
##################################################
[request_definition]
# usr = user ID (system scope)
# sub = profile ID (org scope)
# org = organization ID
# dom = domain (context/bounded context)
# res = resource type (e.g., "project")
# rid = resource ID (e.g., "project-123")
# act = action (e.g., "create", "view")
r = usr, sub, org, dom, res, rid, act, cqrs, scope


##################################################
# Policy Definition
# Describes how each policy rule is structured
##################################################
[policy_definition]
# role = role name (e.g., "editor")
# dom  = domain name (e.g., "loan", "project")
# res  = resource type (same as in request)
# act  = action
# cqrs = "c" or "q" to separate command/query if needed
# meta = optional metadata (used for narration or UI)
p = role, dom, res, act, cqrs, meta


##################################################
# Role Definition
# g: profile-based role binding (org scope)         → g(sub, role, org)
# g2: organization-scoped resource ownership        → g2(org, res_type, res_id)
# g3: system user role binding (user-scope)         → g3(usr, role)
# g4: user-scoped resource ownership                → g4(usr, res_type, res_id)
# g5: org-sub resource ownership                    → g5(sub, role, org, res_id)
##################################################
[role_definition]
g = _, _, _
g2 = _, _, _
g3 = _, _
g4 = _, _, _
g5 = _, _, _

##################################################
# Policy Effect
# Returns allow if any matched policy line has p.eft == allow
##################################################
[policy_effect]
e = some(where (p.eft == allow))


##################################################
# Matchers
# Matchers define the logic to determine if a given request is allowed by the policy.
# 
# This model supports both organization-scoped (ORG) and user-scoped (USER) access:
#  - For SYSTEM-scope requests:
#       - The subject (`r.sub`) must have the policy role (`p.role`) in the given organization (`r.org`) via `g(sub, role, org)`.
#       - Request and policy must match on CQRS type (`cqrs`), domain (`dom`), resource type (`res`), and action (`act`).
#       - This is for system-wide access control.
#       - Each Platform have only one System Organization.
#  - For ORG-scope requests:
#       - The subject (`r.sub`) must have the policy role (`p.role`) in the given organization (`r.org`) via `g(sub, role, org)`.
#       - Request and policy must match on CQRS type (`cqrs`), domain (`dom`), resource type (`res`), and action (`act`).
#       - If a resource ID (`r.rid`) is provided, it must belong to the org and resource type via `g2(org, res, rid)`.
#         If `r.rid` is blank, this is considered a non-specific ("all resources" in org) match.
#  - For ORG-Sub Resource scope requests:
#       - The subject (`r.sub`) must have the policy role (`p.role`) in the given organization (`r.org`) via `g(sub, role, org)`.
#       - Request and policy must match on CQRS type (`cqrs`), domain (`dom`), resource type (`res`), and action (`act`).
#       - If a resource ID (`r.rid`) is provided, it must belong to the org and resource type via `g2(org, res, rid)`.
#         If `r.rid` is blank, this is considered a non-specific ("all resources" in org) match.
#       - Alternatively, role/resource scoping can be enforced at the org scope using `g5(sub, role, org, res, rid)` for more granular constraints.
#  - For USER-scope requests:
#       - The user (`r.usr`) must have the policy role (`p.role`) via `g3(usr, role)`.
#       - Request and policy must match on CQRS type (`cqrs`), domain (`dom`), resource type (`res`), and action (`act`).
#       - If a resource ID (`r.rid`) is provided, it must belong to the user and resource type via `g4(usr, res, rid)`.
#         If `r.rid` is blank, this is considered a non-specific ("all resources" for user) match.
# 
# Effectively, this setup allows RBAC on both organization and system/user scope, with resource ownership mechanics.

##################################################
[matchers]
m = ( \
        r.scope == 'SYS' && g(r.sub, p.role, r.org) && \
        (p.dom == '*' || p.dom == r.dom) && \
        (p.res == '*' || p.res == r.res) && \
        (p.act == '*' || p.act == r.act) && \
        (p.cqrs == '*' || p.cqrs == r.cqrs) \
    ) \
    || \
    ( \
        r.scope == 'ORG' && g(r.sub, p.role, r.org) && \
        r.cqrs == p.cqrs && \
        r.dom == p.dom && \
        r.res == p.res && \
        r.act == p.act && \
        ( r.rid == '' || g2(r.org, r.res, r.rid) ) \
    ) \
    || \
    ( \
        r.scope == 'ORG' && g5(r.sub, p.role, r.rid) && \
        r.cqrs == p.cqrs && \
        r.dom == p.dom && \
        r.res == p.res && \
        r.act == p.act && \
        g2(r.org, r.res, r.rid) \
    ) \
    || \
    ( \
        r.scope == 'USER' && g3(r.usr, p.role) && \
        r.cqrs == p.cqrs && \
        r.dom == p.dom && \
        r.res == p.res && \
        r.act == p.act && \
        ( r.rid == '' || g4(r.usr, r.res, r.rid)) \
    )
